#!/usr/bin/env ruby

require 'colorize'
require 'digest/md5'

$:.unshift("lib")
require 'formats_lines'
require 'formats_tests'
require 'sml_file'
require 'test_output'
require 'test_output_presenter'

class Runner
  def self.main(input)
    new(input)
  end

  def initialize(input)
    @input = input || ""
    check_for_correct_input

    @file = SmlFile.new(@input).prepare_tests

    tmp_file_name = random_name

    @file.save_as!(tmp_file_name + ".sml")

    @file.compile!(random_name + ".exe")

    output = TestOutput.new(@file.run.split("\n"))
    puts TestOutputPresenter.parse(output)
  rescue SmlFile::CannotCompile => e
    output = TestOutput.new(e.message.split("\n"))
    puts TestOutputPresenter.parse(output).gsub(tmp_file_name+".sml", @input)
  ensure
    clean_up!
  end

  private

  def clean_up!
    [".uo", ".ui", ".exe"].each do |s|
      FileUtils.rm_f(File.basename(@file.path, ".*") + s)
    end

    @file.delete!
  end

  def random_name
    Digest::MD5.hexdigest(Time.now.to_s)
  end

  def check_for_correct_input
    if !valid_file_input
      puts "Gimme an sml file, that exists!"
      exit 1
    end
  end

  def valid_file_input
    @input && File.exists?(@input) && File.extname(@input) == ".sml"
  end
end

Runner.main(ARGV.first)
